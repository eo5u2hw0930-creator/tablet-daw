
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#00ff88">
    <meta name="description" content="TabletDAW - Mobile Music Studio">
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TabletDAW">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- Android -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>TabletDAW - Mobile Music Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-grid: #1a1a22;
            --accent-green: #00ff88;
            --accent-pink: #ff3399;
            --accent-cyan: #00d4ff;
            --accent-purple: #9966ff;
            --accent-orange: #ff6633;
            --accent-yellow: #ffcc00;
            --text-primary: #ffffff;
            --text-secondary: #8888aa;
            --border-color: #2a2a3a;
            --grid-line: rgba(255,255,255,0.06);
            --grid-line-bar: rgba(255,255,255,0.2);
            
            --cell-width: 25px;
            --cell-height: 18px;
            --beats-per-bar: 4;
            --bar-width: calc(var(--cell-width) * var(--beats-per-bar));
            --piano-width: 44px;
            --track-info-width: 100px;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --safe-left: env(safe-area-inset-left);
            --safe-right: env(safe-area-inset-right);
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            user-select: none;
            -webkit-user-select: none;
            padding: var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
        }

        /* Start Screen */
        .start-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(ellipse at 50% 0%, rgba(0,255,136,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(153,102,255,0.06) 0%, transparent 40%);
        }

        .start-screen.hidden { display: none; }

        .start-logo {
            font-size: clamp(32px, 8vw, 48px);
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .start-subtitle {
            font-size: clamp(12px, 3vw, 14px);
            color: var(--text-secondary);
            margin-bottom: 40px;
        }

        .new-project-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 40px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink));
            border: none;
            border-radius: 12px;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            font-size: clamp(14px, 4vw, 18px);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 32px rgba(153,102,255,0.3);
        }

        .new-project-btn:active {
            transform: scale(0.95);
        }

        .install-hint {
            position: absolute;
            bottom: 20px;
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            padding: 0 20px;
        }

        /* App Container */
        .app-container {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .app-container.show { display: flex; }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            flex-wrap: wrap;
            min-height: 50px;
        }

        .toolbar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .toolbar-btn:active {
            transform: scale(0.95);
            background: var(--bg-grid);
        }

        .toolbar-btn.new-project {
            background: var(--accent-purple);
            color: #fff;
            border-color: var(--accent-purple);
        }

        .toolbar-btn.play {
            background: var(--accent-green);
            color: #000;
            border-color: var(--accent-green);
            min-width: 70px;
        }

        .toolbar-btn.play.playing {
            background: var(--accent-orange);
            border-color: var(--accent-orange);
        }

        .toolbar-btn.stop {
            background: var(--accent-pink);
            color: #000;
            border-color: var(--accent-pink);
        }

        .toolbar-btn.active {
            background: var(--accent-cyan);
            color: #000;
            border-color: var(--accent-cyan);
        }

        .bpm-control {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .bpm-label {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .bpm-input {
            width: 50px;
            padding: 6px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .track-selector {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .track-dropdown {
            padding: 6px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            max-width: 100px;
        }

        .instrument-selector {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .instrument-dropdown {
            padding: 6px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        .time-display {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-cyan);
            background: var(--bg-tertiary);
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin-left: auto;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.show { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            max-width: 350px;
            width: 100%;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--accent-purple);
        }

        .modal-message {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 16px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .modal-btn.cancel {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-btn.confirm {
            background: var(--accent-purple);
            color: #fff;
            border-color: var(--accent-purple);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        /* Piano Roll */
        .piano-roll-section {
            display: flex;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .piano-roll-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .piano-keys {
            display: flex;
            flex-direction: column;
            width: var(--piano-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .piano-keys::-webkit-scrollbar { display: none; }

        .piano-key {
            height: var(--cell-height);
            min-height: var(--cell-height);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 4px;
            font-size: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.3);
            cursor: pointer;
            flex-shrink: 0;
        }

        .piano-key.white {
            background: linear-gradient(90deg, #d0d0d0, #ffffff);
            color: #555;
        }

        .piano-key.black {
            background: linear-gradient(90deg, #1a1a1a, #2a2a2a);
            color: #777;
        }

        .piano-key.playing {
            background: var(--accent-green) !important;
            color: #000 !important;
        }

        /* Timeline */
        .timeline-wrapper {
            display: flex;
            height: 22px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .timeline-spacer {
            width: var(--piano-width);
            flex-shrink: 0;
            border-right: 1px solid var(--border-color);
        }

        .timeline {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .timeline-inner {
            display: flex;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
        }

        .timeline-bar {
            width: var(--bar-width);
            min-width: var(--bar-width);
            font-size: 9px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            padding-left: 4px;
            border-right: 1px solid var(--grid-line-bar);
        }

        /* Grid */
        .piano-grid-wrapper {
            flex: 1;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        .piano-grid {
            position: relative;
        }

        .grid-row {
            display: flex;
            height: var(--cell-height);
        }

        .grid-row.black-key { background: rgba(0,0,0,0.3); }
        .grid-row.c-note { border-bottom: 1px solid var(--grid-line-bar); }

        .grid-cell {
            width: var(--cell-width);
            min-width: var(--cell-width);
            height: 100%;
            border-right: 1px solid var(--grid-line);
            border-bottom: 1px solid var(--grid-line);
            cursor: crosshair;
            flex-shrink: 0;
        }

        .grid-cell.bar-start { border-right: 1px solid var(--grid-line-bar); }

        /* Notes */
        .note {
            position: absolute;
            height: calc(var(--cell-height) - 2px);
            border-radius: 3px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            padding-left: 3px;
            font-size: 7px;
            color: rgba(0,0,0,0.6);
            overflow: hidden;
        }

        .note.selected { box-shadow: 0 0 0 2px #fff; }
        .note.preview { opacity: 0.5; pointer-events: none; }

        .note-resize {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 12px;
            cursor: ew-resize;
            background: rgba(0,0,0,0.2);
            border-radius: 0 3px 3px 0;
        }

        /* Playhead */
        .playhead {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: #ff3333;
            box-shadow: 0 0 8px #ff3333;
            z-index: 100;
            pointer-events: none;
        }

        /* Tracks Section */
        .audio-tracks-section {
            display: flex;
            flex-direction: column;
            border-top: 2px solid var(--border-color);
            max-height: 30%;
            min-height: 80px;
            overflow: hidden;
        }

        .tracks-header {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            gap: 8px;
            flex-shrink: 0;
        }

        .tracks-header h3 {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .tracks-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .audio-track {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            height: 55px;
            min-height: 55px;
        }

        .audio-track.active { background: rgba(0,255,136,0.05); }

        .track-info {
            width: 100px;
            padding: 4px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 2px;
        }

        .track-name-input {
            background: transparent;
            border: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: 9px;
            font-weight: 600;
            width: 100%;
        }

        .track-instrument-select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 8px;
            color: var(--accent-cyan);
            padding: 2px;
            width: 100%;
        }

        .track-controls {
            display: flex;
            gap: 2px;
            margin-top: 2px;
        }

        .track-btn {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            color: var(--text-secondary);
            font-size: 7px;
            font-weight: 700;
            cursor: pointer;
        }

        .track-btn.active {
            background: var(--accent-green);
            color: #000;
        }

        .track-btn.mute.active {
            background: var(--accent-orange);
        }

        .track-btn.delete {
            background: var(--accent-pink);
            color: #000;
        }

        .track-notes-preview {
            flex: 1;
            position: relative;
            background: var(--bg-grid);
            overflow: hidden;
        }

        .track-preview-inner {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
        }

        .track-bar-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background: var(--grid-line-bar);
        }

        .track-note-bar {
            position: absolute;
            height: 3px;
            border-radius: 1px;
        }

        .track-playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff3333;
            z-index: 50;
        }

        /* Logo */
        .logo {
            font-size: 12px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 2px; }

        /* Landscape optimization */
        @media (max-height: 500px) {
            .toolbar { padding: 4px 6px; min-height: 40px; }
            .toolbar-btn { padding: 6px 10px; font-size: 10px; }
            .audio-tracks-section { max-height: 25%; min-height: 60px; }
            .audio-track { height: 50px; min-height: 50px; }
        }

        /* Phone portrait */
        @media (max-width: 600px) and (orientation: portrait) {
            :root {
                --cell-width: 20px;
                --cell-height: 16px;
                --piano-width: 36px;
            }
            .toolbar { gap: 4px; }
            .toolbar-btn { padding: 6px 8px; font-size: 10px; }
            .track-info { width: 80px; }
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div class="start-screen" id="startScreen">
        <div class="start-logo">TabletDAW</div>
        <div class="start-subtitle">Mobile Music Studio</div>
        <button class="new-project-btn" onclick="createNewProject()">
            <span>üìÑ</span> ÏÉà ÌîÑÎ°úÏ†ùÌä∏
        </button>
        <div class="install-hint" id="installHint"></div>
    </div>

    <!-- App Container -->
    <div class="app-container" id="appContainer">
        <div class="modal-overlay" id="modalOverlay">
            <div class="modal">
                <div class="modal-title">ÏÉà ÌîÑÎ°úÏ†ùÌä∏</div>
                <div class="modal-message">ÌòÑÏû¨ ÌîÑÎ°úÏ†ùÌä∏Ïùò Î™®Îì† ÎÇ¥Ïö©Ïù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?</div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeModal()">Ï∑®ÏÜå</button>
                    <button class="modal-btn confirm" onclick="confirmNewProject()">ÌôïÏù∏</button>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <span class="logo">TabletDAW</span>
            <button class="toolbar-btn new-project" onclick="showNewProjectModal()">üìÑ</button>
            <button class="toolbar-btn play" id="playBtn" onclick="togglePlay()">
                <span id="playIcon">‚ñ∂</span>
            </button>
            <button class="toolbar-btn stop" onclick="stopPlayback()">‚èπ</button>
            <div class="bpm-control">
                <span class="bpm-label">BPM</span>
                <input type="number" class="bpm-input" id="bpmInput" value="120" min="60" max="200">
            </div>
            <button class="toolbar-btn active" id="auditionBtn" onclick="toggleAudition()">üîä</button>
            <div class="track-selector">
                <select class="track-dropdown" id="trackSelect" onchange="switchTrack()">
                    <option value="0">Track 1</option>
                </select>
                <button class="toolbar-btn" onclick="addNewTrack()">+</button>
                <button class="toolbar-btn" onclick="deleteCurrentTrack()">-</button>
            </div>
            <div class="instrument-selector">
                <select class="instrument-dropdown" id="instrumentSelect" onchange="changeCurrentInstrument()">
                </select>
            </div>
            <div class="time-display" id="timeDisplay">00:00</div>
        </div>

        <div class="main-content">
            <div class="piano-roll-section">
                <div class="timeline-wrapper">
                    <div class="timeline-spacer"></div>
                    <div class="timeline" id="timeline">
                        <div class="timeline-inner" id="timelineInner"></div>
                    </div>
                </div>
                <div class="piano-roll-container">
                    <div class="piano-keys" id="pianoKeys"></div>
                    <div class="piano-grid-wrapper" id="pianoGridWrapper">
                        <div class="piano-grid" id="pianoGrid">
                            <div class="playhead" id="playhead"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="audio-tracks-section">
                <div class="tracks-header">
                    <h3>TRACKS</h3>
                    <button class="toolbar-btn" onclick="addAudioTrack()" style="padding:4px 8px;font-size:9px;">+ Add</button>
                </div>
                <div class="tracks-container" id="tracksContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW registration failed:', err));
        }

        // Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installHint').innerHTML = 
                'üí° Ìôà ÌôîÎ©¥Ïóê Ï∂îÍ∞ÄÌïòÎ†§Î©¥ Î∏åÎùºÏö∞Ï†Ä Î©îÎâ¥ÏóêÏÑú "Ìôà ÌôîÎ©¥Ïóê Ï∂îÍ∞Ä"Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî';
        });

        // Instruments configuration
        const INSTRUMENTS = {
            piano: {
                name: 'üéπ Piano',
                type: 'triangle',
                attack: 0.02,
                decay: 0.3,
                sustain: 0.4,
                release: 0.3,
                harmonics: [1, 0.5, 0.25]
            },
            synth: {
                name: 'üéõÔ∏è Synth',
                type: 'sawtooth',
                attack: 0.05,
                decay: 0.2,
                sustain: 0.6,
                release: 0.2,
                harmonics: [1]
            },
            bass: {
                name: 'üé∏ Bass',
                type: 'sine',
                attack: 0.02,
                decay: 0.1,
                sustain: 0.7,
                release: 0.1,
                harmonics: [1, 0.5],
                octaveShift: -1
            },
            organ: {
                name: 'üéµ Organ',
                type: 'sine',
                attack: 0.05,
                decay: 0.1,
                sustain: 0.9,
                release: 0.1,
                harmonics: [1, 1, 0.5, 0.25]
            },
            pad: {
                name: '‚òÅÔ∏è Pad',
                type: 'sine',
                attack: 0.4,
                decay: 0.3,
                sustain: 0.7,
                release: 0.5,
                harmonics: [1, 0.3]
            },
            pluck: {
                name: 'ü™ï Pluck',
                type: 'triangle',
                attack: 0.01,
                decay: 0.2,
                sustain: 0.1,
                release: 0.1,
                harmonics: [1, 0.7, 0.3]
            },
            square: {
                name: 'üî≤ Square',
                type: 'square',
                attack: 0.02,
                decay: 0.1,
                sustain: 0.5,
                release: 0.1,
                harmonics: [1]
            },
            bell: {
                name: 'üîî Bell',
                type: 'sine',
                attack: 0.01,
                decay: 0.5,
                sustain: 0.2,
                release: 0.4,
                harmonics: [1, 0.6, 0.4, 0.3],
                detuneAmount: 5
            }
        };

        // Config
        const CELL_WIDTH = 25, CELL_HEIGHT = 18, TOTAL_BARS = 16, BEATS_PER_BAR = 4;
        const TOTAL_BEATS = TOTAL_BARS * BEATS_PER_BAR;
        const BAR_WIDTH = CELL_WIDTH * BEATS_PER_BAR;
        const GRID_TOTAL_WIDTH = CELL_WIDTH * TOTAL_BEATS;
        const TRACK_COLORS = ['#00ff88','#ff3399','#00d4ff','#ffcc00','#9966ff','#ff6633','#33ff99','#ff66cc'];

        let audioContext = null, isPlaying = false, bpm = 120, playheadPosition = 0;
        let animationFrame = null, startTime = 0, currentTrackIndex = 0, auditionEnabled = true;
        let isDrawing = false, drawStartBeat = 0, drawStartRow = 0, drawStartNote = '', previewNote = null;
        let tracks = [];
        const activeOscillators = new Map();
        const keyNames = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        const octaves = [6,5,4,3,2,1];
        const blackKeyIndices = [1,3,6,8,10];
        const totalRows = octaves.length * 12;

        // Initialize instrument dropdown
        function initInstrumentDropdown() {
            const select = document.getElementById('instrumentSelect');
            select.innerHTML = '';
            Object.keys(INSTRUMENTS).forEach(key => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = INSTRUMENTS[key].name;
                select.appendChild(opt);
            });
        }

        // Change current track instrument
        function changeCurrentInstrument() {
            const instrument = document.getElementById('instrumentSelect').value;
            tracks[currentTrackIndex].instrument = instrument;
            const trackEl = document.querySelector(`.audio-track[data-track-id="${currentTrackIndex}"] .track-instrument-select`);
            if (trackEl) trackEl.value = instrument;
        }

        // Change track instrument from track panel
        function changeTrackInstrument(trackId, instrument) {
            tracks[trackId].instrument = instrument;
            if (trackId === currentTrackIndex) {
                document.getElementById('instrumentSelect').value = instrument;
            }
        }

        // Modal
        function showNewProjectModal() { document.getElementById('modalOverlay').classList.add('show'); }
        function closeModal() { document.getElementById('modalOverlay').classList.remove('show'); }
        function confirmNewProject() { closeModal(); resetProject(); }

        function createNewProject() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.add('show');
            initInstrumentDropdown();
            initProject();
        }

        function resetProject() {
            stopPlayback();
            tracks = [{ name: 'Track 1', notes: [], color: TRACK_COLORS[0], muted: false, solo: false, instrument: 'piano' }];
            currentTrackIndex = 0;
            bpm = 120;
            document.getElementById('bpmInput').value = 120;
            document.getElementById('instrumentSelect').value = 'piano';
            playheadPosition = 0;
            document.getElementById('trackSelect').innerHTML = '<option value="0">Track 1</option>';
            rebuildTrackUI();
            renderNotes();
            updateTrackPreviews();
            updateTrackSelection();
            updateTimeDisplay(0);
            updatePlayheadUI();
        }

        function initProject() {
            tracks = [{ name: 'Track 1', notes: [], color: TRACK_COLORS[0], muted: false, solo: false, instrument: 'piano' }];
            initTimeline();
            initPianoRoll();
            setupGridDrawing();
            syncScroll();
            rebuildTrackUI();
            updateTrackPreviews();
            updateTrackSelection();
        }

        function rebuildTrackUI() {
            const c = document.getElementById('tracksContainer');
            c.innerHTML = '';
            tracks.forEach((t, i) => {
                const instrumentOptions = Object.keys(INSTRUMENTS).map(key => 
                    `<option value="${key}" ${t.instrument === key ? 'selected' : ''}>${INSTRUMENTS[key].name}</option>`
                ).join('');
                
                c.insertAdjacentHTML('beforeend', `
                    <div class="audio-track ${i === currentTrackIndex ? 'active' : ''}" data-track-id="${i}">
                        <div class="track-info">
                            <input type="text" class="track-name-input" value="${t.name}" maxlength="12" style="color:${t.color};">
                            <select class="track-instrument-select" onchange="changeTrackInstrument(${i}, this.value)">
                                ${instrumentOptions}
                            </select>
                            <div class="track-controls">
                                <button class="track-btn solo ${t.solo?'active':''}" onclick="toggleSolo(this,${i})">S</button>
                                <button class="track-btn mute ${t.muted?'active':''}" onclick="toggleMute(this,${i})">M</button>
                                <button class="track-btn delete" onclick="deleteAudioTrack(this)">‚úï</button>
                            </div>
                        </div>
                        <div class="track-notes-preview" data-track-id="${i}" onclick="selectTrackFromPreview(${i})">
                            <div class="track-preview-inner"></div>
                            <div class="track-playhead" style="left:0;"></div>
                        </div>
                    </div>
                `);
            });
        }

        function initTimeline() {
            const t = document.getElementById('timelineInner');
            t.innerHTML = '';
            t.style.width = GRID_TOTAL_WIDTH + 'px';
            for (let i = 1; i <= TOTAL_BARS; i++) {
                const b = document.createElement('div');
                b.className = 'timeline-bar';
                b.textContent = i;
                b.style.width = b.style.minWidth = BAR_WIDTH + 'px';
                t.appendChild(b);
            }
        }

        function initPianoRoll() {
            const keys = document.getElementById('pianoKeys');
            const grid = document.getElementById('pianoGrid');
            keys.innerHTML = '';
            grid.innerHTML = '<div class="playhead" id="playhead"></div>';
            grid.style.width = GRID_TOTAL_WIDTH + 'px';
            grid.style.height = totalRows * CELL_HEIGHT + 'px';

            let row = 0;
            octaves.forEach(oct => {
                for (let i = 11; i >= 0; i--) {
                    const name = keyNames[i], full = name + oct;
                    const isBlack = blackKeyIndices.includes(i), isC = i === 0;

                    const key = document.createElement('div');
                    key.className = 'piano-key ' + (isBlack ? 'black' : 'white');
                    key.textContent = full;
                    key.dataset.note = full;
                    key.dataset.row = row;
                    key.addEventListener('touchstart', e => { e.preventDefault(); playNotePreview(key); }, { passive: false });
                    key.addEventListener('touchend', () => stopNotePreview(key));
                    key.addEventListener('mousedown', () => playNotePreview(key));
                    key.addEventListener('mouseup', () => stopNotePreview(key));
                    key.addEventListener('mouseleave', () => stopNotePreview(key));
                    keys.appendChild(key);

                    const r = document.createElement('div');
                    r.className = 'grid-row' + (isBlack ? ' black-key' : '') + (isC ? ' c-note' : '');
                    r.dataset.note = full;
                    r.dataset.row = row;

                    for (let beat = 0; beat < TOTAL_BEATS; beat++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell' + ((beat + 1) % BEATS_PER_BAR === 0 ? ' bar-start' : '');
                        cell.dataset.beat = beat;
                        cell.dataset.row = row;
                        cell.dataset.note = full;
                        r.appendChild(cell);
                    }
                    grid.appendChild(r);
                    row++;
                }
            });
            grid.addEventListener('contextmenu', e => e.preventDefault());
            renderNotes();
        }

        function setupGridDrawing() {
            const grid = document.getElementById('pianoGrid');

            const startDraw = (e) => {
                if (e.button === 2) return;
                const cell = e.target.closest('.grid-cell');
                if (!cell) return;
                e.preventDefault();
                isDrawing = true;
                drawStartBeat = parseInt(cell.dataset.beat);
                drawStartRow = parseInt(cell.dataset.row);
                drawStartNote = cell.dataset.note;
                if (auditionEnabled) startSustainedNote(drawStartNote);
                createPreviewNote(drawStartRow, drawStartBeat, 1);
            };

            const moveDraw = (e) => {
                if (!isDrawing) return;
                const touch = e.touches ? e.touches[0] : e;
                const wrapper = document.getElementById('pianoGridWrapper');
                const rect = wrapper.getBoundingClientRect();
                const x = touch.clientX - rect.left + wrapper.scrollLeft;
                const len = Math.max(1, Math.floor(x / CELL_WIDTH) - drawStartBeat + 1);
                if (previewNote) previewNote.style.width = (len * CELL_WIDTH - 2) + 'px';
            };

            const endDraw = () => {
                if (!isDrawing) return;
                isDrawing = false;
                stopSustainedNote(drawStartNote);
                if (previewNote) {
                    const len = Math.max(1, Math.round((parseFloat(previewNote.style.width) + 2) / CELL_WIDTH));
                    const t = tracks[currentTrackIndex];
                    const exists = t.notes.findIndex(n => n.row === drawStartRow &&
                        ((n.beat <= drawStartBeat && n.beat + n.length > drawStartBeat) ||
                         (drawStartBeat <= n.beat && drawStartBeat + len > n.beat)));
                    if (exists === -1) t.notes.push({ note: drawStartNote, row: drawStartRow, beat: drawStartBeat, length: len });
                    previewNote.remove();
                    previewNote = null;
                    renderNotes();
                    updateTrackPreviews();
                }
            };

            grid.addEventListener('mousedown', startDraw);
            document.addEventListener('mousemove', moveDraw);
            document.addEventListener('mouseup', endDraw);
            grid.addEventListener('touchstart', startDraw, { passive: false });
            document.addEventListener('touchmove', moveDraw, { passive: false });
            document.addEventListener('touchend', endDraw);
        }

        function createPreviewNote(row, beat, len) {
            const grid = document.getElementById('pianoGrid');
            previewNote = document.createElement('div');
            previewNote.className = 'note preview';
            previewNote.style.left = beat * CELL_WIDTH + 'px';
            previewNote.style.top = (row * CELL_HEIGHT + 1) + 'px';
            previewNote.style.width = (len * CELL_WIDTH - 2) + 'px';
            previewNote.style.background = tracks[currentTrackIndex].color;
            grid.appendChild(previewNote);
        }

        function renderNotes() {
            document.querySelectorAll('.note:not(.preview)').forEach(n => n.remove());
            const t = tracks[currentTrackIndex];
            if (!t) return;
            const grid = document.getElementById('pianoGrid');
            t.notes.forEach((n, i) => {
                const el = document.createElement('div');
                el.className = 'note';
                el.style.left = n.beat * CELL_WIDTH + 'px';
                el.style.top = (n.row * CELL_HEIGHT + 1) + 'px';
                el.style.width = (n.length * CELL_WIDTH - 2) + 'px';
                el.style.background = t.color;
                el.style.boxShadow = '0 1px 4px ' + t.color + '66';
                el.dataset.index = i;
                el.textContent = n.note;
                const resize = document.createElement('div');
                resize.className = 'note-resize';
                el.appendChild(resize);
                setupNoteInteractions(el, n, i);
                grid.appendChild(el);
            });
        }

        function setupNoteInteractions(el, data, idx) {
            let drag = false, resize = false, sx, sy, sb, sr, sl;
            const handle = el.querySelector('.note-resize');

            let longPress = null;
            el.addEventListener('touchstart', (e) => {
                longPress = setTimeout(() => { deleteNoteAtIndex(idx); }, 500);
            }, { passive: true });
            el.addEventListener('touchend', () => clearTimeout(longPress));
            el.addEventListener('touchmove', () => clearTimeout(longPress));

            el.addEventListener('contextmenu', e => { e.preventDefault(); e.stopPropagation(); deleteNoteAtIndex(idx); });

            const startResize = (e) => {
                e.stopPropagation(); e.preventDefault();
                resize = true;
                sx = e.touches ? e.touches[0].clientX : e.clientX;
                sl = data.length;
                el.classList.add('selected');
            };
            handle.addEventListener('touchstart', startResize, { passive: false });
            handle.addEventListener('mousedown', startResize);

            const startDrag = (e) => {
                if (resize || e.button === 2) return;
                e.preventDefault(); e.stopPropagation();
                drag = true;
                sx = e.touches ? e.touches[0].clientX : e.clientX;
                sy = e.touches ? e.touches[0].clientY : e.clientY;
                sb = data.beat; sr = data.row;
                el.classList.add('selected');
                if (auditionEnabled) startSustainedNote(data.note);
            };
            el.addEventListener('touchstart', startDrag, { passive: false });
            el.addEventListener('mousedown', startDrag);

            const handleMove = (e) => {
                if (!drag && !resize) return;
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                const dx = cx - sx, dy = cy - sy;

                if (resize) {
                    data.length = Math.max(1, sl + Math.round(dx / CELL_WIDTH));
                    el.style.width = (data.length * CELL_WIDTH - 2) + 'px';
                } else if (drag) {
                    const nb = Math.max(0, Math.min(TOTAL_BEATS - data.length, sb + Math.round(dx / CELL_WIDTH)));
                    const nr = Math.max(0, Math.min(totalRows - 1, sr + Math.round(dy / CELL_HEIGHT)));
                    data.beat = nb;
                    if (nr !== data.row) {
                        const oi = Math.floor(nr / 12), ni = 11 - (nr % 12);
                        data.row = nr;
                        data.note = keyNames[ni] + octaves[oi];
                        el.textContent = data.note;
                        const newR = document.createElement('div');
                        newR.className = 'note-resize';
                        el.appendChild(newR);
                        if (auditionEnabled) { stopAllSustainedNotes(); startSustainedNote(data.note); }
                    }
                    el.style.left = nb * CELL_WIDTH + 'px';
                    el.style.top = (nr * CELL_HEIGHT + 1) + 'px';
                }
            };
            document.addEventListener('touchmove', handleMove, { passive: false });
            document.addEventListener('mousemove', handleMove);

            const handleEnd = () => {
                if (drag || resize) {
                    drag = false; resize = false;
                    el.classList.remove('selected');
                    stopAllSustainedNotes();
                    updateTrackPreviews();
                }
            };
            document.addEventListener('touchend', handleEnd);
            document.addEventListener('mouseup', handleEnd);

            let lastTap = 0;
            el.addEventListener('touchend', () => { if (Date.now() - lastTap < 300) deleteNoteAtIndex(idx); lastTap = Date.now(); });
            el.addEventListener('dblclick', () => deleteNoteAtIndex(idx));
        }

        function deleteNoteAtIndex(i) {
            tracks[currentTrackIndex].notes.splice(i, 1);
            renderNotes();
            updateTrackPreviews();
        }

        function updateTrackPreviews() {
            tracks.forEach((t, ti) => {
                const c = document.querySelector(`.track-notes-preview[data-track-id="${ti}"]`);
                if (!c) return;
                const inner = c.querySelector('.track-preview-inner');
                if (!inner) return;
                inner.innerHTML = '';
                const w = c.clientWidth, h = c.clientHeight, scale = w / GRID_TOTAL_WIDTH;
                inner.style.width = w + 'px';
                for (let i = 1; i < TOTAL_BARS; i++) {
                    const l = document.createElement('div');
                    l.className = 'track-bar-line';
                    l.style.left = i * BAR_WIDTH * scale + 'px';
                    inner.appendChild(l);
                }
                t.notes.forEach(n => {
                    const b = document.createElement('div');
                    b.className = 'track-note-bar';
                    b.style.left = n.beat * CELL_WIDTH * scale + 'px';
                    b.style.top = (n.row / totalRows) * h + 'px';
                    b.style.width = Math.max(2, n.length * CELL_WIDTH * scale) + 'px';
                    b.style.background = t.color;
                    inner.appendChild(b);
                });
            });
        }

        function updateTrackSelection() {
            document.querySelectorAll('.audio-track').forEach((el, i) => el.classList.toggle('active', i === currentTrackIndex));
            document.getElementById('instrumentSelect').value = tracks[currentTrackIndex].instrument || 'piano';
        }

        function selectTrackFromPreview(id) {
            currentTrackIndex = id;
            document.getElementById('trackSelect').value = id;
            renderNotes();
            updateTrackSelection();
        }

        function syncScroll() {
            const keys = document.getElementById('pianoKeys');
            const wrapper = document.getElementById('pianoGridWrapper');
            const timeline = document.getElementById('timelineInner');
            wrapper.addEventListener('scroll', () => {
                keys.scrollTop = wrapper.scrollTop;
                timeline.style.transform = `translateX(-${wrapper.scrollLeft}px)`;
            });
        }

        // Audio
        function initAudio() {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioContext.resume();
        }

        function createInstrumentSound(freq, instrument, gainNode, duration) {
            const inst = INSTRUMENTS[instrument] || INSTRUMENTS.piano;
            const oscillators = [];
            
            inst.harmonics.forEach((harmGain, index) => {
                const osc = audioContext.createOscillator();
                const oscGain = audioContext.createGain();
                
                osc.type = inst.type;
                let finalFreq = freq * (index + 1);
                if (inst.octaveShift) finalFreq *= Math.pow(2, inst.octaveShift);
                osc.frequency.value = finalFreq;
                
                if (inst.detuneAmount && index > 0) {
                    osc.detune.value = inst.detuneAmount * index;
                }
                
                oscGain.gain.value = harmGain * 0.15;
                osc.connect(oscGain);
                oscGain.connect(gainNode);
                oscillators.push(osc);
            });
            
            return oscillators;
        }

        function applyEnvelope(gainNode, instrument, duration) {
            const inst = INSTRUMENTS[instrument] || INSTRUMENTS.piano;
            const now = audioContext.currentTime;
            const totalDur = (60 / bpm) * duration;
            
            const attackEnd = now + inst.attack;
            const decayEnd = attackEnd + inst.decay;
            const sustainEnd = now + totalDur - inst.release;
            const releaseEnd = now + totalDur;
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(1, attackEnd);
            gainNode.gain.linearRampToValueAtTime(inst.sustain, decayEnd);
            gainNode.gain.setValueAtTime(inst.sustain, Math.max(decayEnd, sustainEnd));
            gainNode.gain.linearRampToValueAtTime(0.001, releaseEnd);
            
            return releaseEnd;
        }

        function startSustainedNote(name) {
            initAudio();
            if (activeOscillators.has(name)) return;
            
            const instrument = tracks[currentTrackIndex].instrument || 'piano';
            const masterGain = audioContext.createGain();
            masterGain.connect(audioContext.destination);
            masterGain.gain.value = 0.3;
            
            const oscillators = createInstrumentSound(noteToFreq(name), instrument, masterGain, 1);
            oscillators.forEach(osc => osc.start());
            
            activeOscillators.set(name, { oscillators, gain: masterGain });
        }

        function stopSustainedNote(name) {
            const a = activeOscillators.get(name);
            if (a) {
                a.gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
                a.oscillators.forEach(osc => osc.stop(audioContext.currentTime + 0.1));
                activeOscillators.delete(name);
            }
        }

        function stopAllSustainedNotes() { activeOscillators.forEach((_, n) => stopSustainedNote(n)); }

        function playNotePreview(key) { key.classList.add('playing'); if (auditionEnabled) startSustainedNote(key.dataset.note); }
        function stopNotePreview(key) { key.classList.remove('playing'); stopSustainedNote(key.dataset.note); }

        function playNoteWithSustain(name, dur, instrument) {
            initAudio();
            const masterGain = audioContext.createGain();
            masterGain.connect(audioContext.destination);
            
            const oscillators = createInstrumentSound(noteToFreq(name), instrument, masterGain, dur);
            const endTime = applyEnvelope(masterGain, instrument, dur);
            
            oscillators.forEach(osc => {
                osc.start();
                osc.stop(endTime);
            });
        }

        function noteToFreq(name) {
            const map = { 'C':0,'C#':1,'D':2,'D#':3,'E':4,'F':5,'F#':6,'G':7,'G#':8,'A':9,'A#':10,'B':11 };
            const n = name.slice(0, -1), o = parseInt(name.slice(-1));
            return 440 * Math.pow(2, (map[n] + (o - 4) * 12 - 9) / 12);
        }

        function toggleAudition() {
            auditionEnabled = !auditionEnabled;
            document.getElementById('auditionBtn').classList.toggle('active', auditionEnabled);
        }

        // Playback
        function togglePlay() { isPlaying ? pausePlayback() : startPlayback(); }

        function startPlayback() {
            initAudio();
            isPlaying = true;
            document.getElementById('playBtn').classList.add('playing');
            document.getElementById('playIcon').textContent = '‚è∏';
            startTime = audioContext.currentTime - (playheadPosition / (bpm / 60) / BEATS_PER_BAR);
            lastPlayedBeat = -1;
            playedNotes.clear();
            animatePlayhead();
        }

        function pausePlayback() {
            isPlaying = false;
            document.getElementById('playBtn').classList.remove('playing');
            document.getElementById('playIcon').textContent = '‚ñ∂';
            cancelAnimationFrame(animationFrame);
        }

        function stopPlayback() {
            pausePlayback();
            playheadPosition = 0;
            updatePlayheadUI();
            updateTimeDisplay(0);
            playedNotes.clear();
        }

        let lastPlayedBeat = -1;
        const playedNotes = new Set();

        function animatePlayhead() {
            if (!isPlaying) return;
            const t = audioContext.currentTime - startTime;
            playheadPosition = (t * (bpm / 60) * CELL_WIDTH) % GRID_TOTAL_WIDTH;
            updatePlayheadUI();
            updateTimeDisplay(t % ((TOTAL_BEATS / BEATS_PER_BAR) * (60 / bpm) * BEATS_PER_BAR));

            const beat = Math.floor(playheadPosition / CELL_WIDTH);
            if (beat !== lastPlayedBeat) {
                if (beat < lastPlayedBeat) playedNotes.clear();
                const hasSolo = tracks.some(t => t.solo);
                tracks.forEach((track, ti) => {
                    if (track.muted || (hasSolo && !track.solo)) return;
                    track.notes.forEach((n, ni) => {
                        const key = `${ti}-${ni}-${n.beat}`;
                        if (beat === n.beat && !playedNotes.has(key)) {
                            playNoteWithSustain(n.note, n.length, track.instrument || 'piano');
                            playedNotes.add(key);
                        }
                    });
                });
                lastPlayedBeat = beat;
            }
            animationFrame = requestAnimationFrame(animatePlayhead);
        }

        function updatePlayheadUI() {
            document.getElementById('playhead').style.left = playheadPosition + 'px';
            const p = playheadPosition / GRID_TOTAL_WIDTH;
            document.querySelectorAll('.track-playhead').forEach(ph => ph.style.left = p * ph.parentElement.clientWidth + 'px');
        }

        function updateTimeDisplay(s) {
            const m = Math.floor(s / 60), sec = Math.floor(s % 60);
            document.getElementById('timeDisplay').textContent = String(m).padStart(2, '0') + ':' + String(sec).padStart(2, '0');
        }

        function updateBPM() {
            bpm = Math.max(60, Math.min(200, parseInt(document.getElementById('bpmInput').value) || 120));
            document.getElementById('bpmInput').value = bpm;
        }

        document.getElementById('bpmInput').addEventListener('change', updateBPM);

        // Track management
        function addNewTrack() {
            const i = tracks.length;
            tracks.push({ name: 'Track ' + (i + 1), notes: [], color: TRACK_COLORS[i % TRACK_COLORS.length], muted: false, solo: false, instrument: 'piano' });
            const sel = document.getElementById('trackSelect');
            const opt = document.createElement('option');
            opt.value = i; opt.textContent = 'Track ' + (i + 1);
            sel.appendChild(opt);
            sel.value = i;
            currentTrackIndex = i;
            renderNotes();
            addAudioTrackUI(i);
            updateTrackSelection();
        }

        function deleteCurrentTrack() {
            if (tracks.length <= 1) return;
            document.querySelector(`.audio-track[data-track-id="${currentTrackIndex}"]`)?.remove();
            tracks.splice(currentTrackIndex, 1);
            const sel = document.getElementById('trackSelect');
            sel.innerHTML = '';
            tracks.forEach((t, i) => { const o = document.createElement('option'); o.value = i; o.textContent = t.name; sel.appendChild(o); });
            document.querySelectorAll('.audio-track').forEach((el, i) => {
                el.dataset.trackId = i;
                el.querySelector('.track-notes-preview').dataset.trackId = i;
                el.querySelector('.track-notes-preview').onclick = () => selectTrackFromPreview(i);
            });
            currentTrackIndex = Math.min(currentTrackIndex, tracks.length - 1);
            sel.value = currentTrackIndex;
            renderNotes();
            updateTrackPreviews();
            updateTrackSelection();
        }

        function switchTrack() {
            currentTrackIndex = parseInt(document.getElementById('trackSelect').value);
            renderNotes();
            updateTrackSelection();
        }

        function addAudioTrackUI(id) {
            const t = tracks[id];
            const instrumentOptions = Object.keys(INSTRUMENTS).map(key => 
                `<option value="${key}" ${t.instrument === key ? 'selected' : ''}>${INSTRUMENTS[key].name}</option>`
            ).join('');
            
            document.getElementById('tracksContainer').insertAdjacentHTML('beforeend', `
                <div class="audio-track" data-track-id="${id}">
                    <div class="track-info">
                        <input type="text" class="track-name-input" value="Track ${id + 1}" maxlength="12" style="color:${t.color};">
                        <select class="track-instrument-select" onchange="changeTrackInstrument(${id}, this.value)">
                            ${instrumentOptions}
                        </select>
                        <div class="track-controls">
                            <button class="track-btn solo" onclick="toggleSolo(this,${id})">S</button>
                            <button class="track-btn mute" onclick="toggleMute(this,${id})">M</button>
                            <button class="track-btn delete" onclick="deleteAudioTrack(this)">‚úï</button>
                        </div>
                    </div>
                    <div class="track-notes-preview" data-track-id="${id}" onclick="selectTrackFromPreview(${id})">
                        <div class="track-preview-inner"></div>
                        <div class="track-playhead" style="left:0;"></div>
                    </div>
                </div>
            `);
            updateTrackPreviews();
        }

        function addAudioTrack() { addNewTrack(); }

        function deleteAudioTrack(btn) {
            const id = parseInt(btn.closest('.audio-track').dataset.trackId);
            if (tracks.length > 1) { currentTrackIndex = id; document.getElementById('trackSelect').value = id; deleteCurrentTrack(); }
        }

        function toggleSolo(btn, id) { tracks[id].solo = !tracks[id].solo; btn.classList.toggle('active', tracks[id].solo); }
        function toggleMute(btn, id) { tracks[id].muted = !tracks[id].muted; btn.classList.toggle('active', tracks[id].muted); }

        // Prevent zoom
        document.addEventListener('touchstart', e => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
        let lastTouchEnd = 0;
        document.addEventListener('touchend', e => { if (Date.now() - lastTouchEnd <= 300) e.preventDefault(); lastTouchEnd = Date.now(); }, false);

        document.getElementById('modalOverlay').addEventListener('click', e => { if (e.target === document.getElementById('modalOverlay')) closeModal(); });
        window.addEventListener('resize', updateTrackPreviews);

        // Wake lock
        if ('wakeLock' in navigator) {
            let wakeLock = null;
            const requestWakeLock = async () => {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
            };
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && isPlaying) requestWakeLock();
            });
        }
    </script>
</body>
</html>
